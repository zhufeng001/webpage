<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head>
<title>UNIX高级编程指南（十九）之二                                                                        _天极网</title>
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<meta http-equiv="Content-Language" content="zh-CN" />
<link rel="alternate" type="application/rss+xml" title="天极网_全球最大中文IT网站 引领中国数字生活 天极网,全球最大的中文IT门户,专注IT产品采购及应" href="http://www.yesky.com/index.xml" />
<link rel="stylesheet" href="http://css.tianjimedia.com/TLimages2009/yesky/css/article.css?time=120202.css" type="text/css" media="all" />
<script src="http://js.tianjimedia.com/TLimages2009/yesky/js/article.js" type="text/javascript"></script>
<base target="_blank">
<!-- baidu-tc/2.0 page{"page_type":"CONTENT","default_action":"DELETE"} -->
</head><body>

<div class="ad980"> </div>
<!-- baidu_tc block_begin"导航内容":{"action":"FOLD","type":"PAGE_NAV"} -->
<style type="text/css">.y_headPos a:link {font-family:"Arial";}.y_headPos {line-height:21px;background:#FFF;font-family:Arial, Helvetica, sans-serif, "宋体";font-size:12px;padding:0;margin:0 auto;position:relative;z-index:9999;clear:both;width:950px;height:109px;}.y_headPos ul, .y_headPos li, .y_headPos span, .y_headPos dl, .y_headPos dt, .y_headPos dd {border:0;padding:0;margin:0;}.y_headfrist, .y_headmore dt, .y_headmore dt.show {background:url(http://image.tianjimedia.com/TLimages2009/yesky/images/index/tnd_navicon.gif) no-repeat;}.y_headtopDiv {height:45px;background-color:#f7f9fb;margin-bottom:3px;}.y_headlogo, .y_headlogin, .y_headlinks {float:left;color:#7b7c7d;display:inline;}.y_headtopDiv a:link, .y_headtopDiv a:visited {color:#7f7f7f;text-decoration:none;}.y_headsel a:link, .y_headsel a:visited, .y_headsta a:link, .y_headsta a:visited {text-decoration:none;color:#0263AD;}.y_headtopDiv a:hover, .y_headtopDiv a:active, .y_headsel a:hover, .y_headsel a:active, .y_headsta a:hover, .y_headsta a:active {text-decoration:underline;}.y_headlogo {
background:url(http://image.tianjimedia.com/TLimages2009/yesky/images/index/tnd_logo.gif) no-repeat;text-indent:-9999em;cursor:pointer;margin:11px 19px 5px 12px;}.y_headlogo a {width:71px;height:28px;display:block;outline:none;blr:expression(this.onFocus=this.blur());}.y_headlogin {margin-top:14px;}.y_headlogin a {margin:0 10px;}.y_headlinks {margin:13px 0 0;float:right;padding-right:6px;}.y_headlinks span a {padding-right:13px;float:left;}	.y_headfrist {background-position:5px 0;padding-left:30px;}.y_headmore {float:left;cursor:pointer;position:relative;z-index:9999;}.y_headmore dt {background-position:9px -67px;float:left;padding-right:12px;}.y_headmore dt.show {background-position:9px -83px;}.y_headmore dd {display:none;}	.y_headmore dd.show {display:block;position:absolute;right:0;top:20px;width:118px;background:#abc5d9;}.y_headmore dd .morek {border:1px solid #7FB5DE;display: block;position:relative;right:1px;top:-2px;width:115px;overflow:hidden;}.y_headmore p,.y_headmore a {overflow:hidden;zoom:1;padding:0;margin:0;}.y_headmore p {background:#fff;padding:5px 0;width:115px;}.y_headmore p a {height:21px;padding:0 7px;overflow:hidden;display:inline-block;}.y_headmore p.bdt {border-top:1px solid #dee0e2;float:left;}/*line two*/.y_headsel {padding-left:4px;clear:both;position:relative;z-index:999;}.y_headsel dd, .y_headsel span {padding:0;margin:0;}.y_headsel dl.show dt a:hover {text-decoration:none;}.y_headsel dl {cursor:pointer;position:relative;float:left;}.y_headsel dt b {
background:url(http://image.tianjimedia.com/TLimages2009/yesky/images/index/tnd_jt12.gif) no-repeat;background-position: center right;}.y_headsel dt {float:left;width:72px;text-align:center;line-height:24px;height:24px;position:relative;display:inline;padding:0 1px 1px 0;cursor:pointer;}.y_headsel dt a {padding-right:10px;}.y_headsel dd {float:left;display:none;text-align:center;}.y_headsel dl.show dt {
background:url(http://image.tianjimedia.com/TLimages2009/yesky/images/index/navonbg.png) repeat-y;overflow:hidden;z-index:9;}.y_headsel dl dt a{text-align:center;background-position:right center;}.y_headsel dt b {overflow:hidden;display:block;z-index:99;font-weight:100;padding:0 7px;border:1px solid #fff;}.y_headsel dl.show dt b {border:1px solid #7fb5de;right:1px;background-color:#C9E0F2;}.y_headsel dd.show {position:absolute;padding-bottom:2px;zoom:1;background:url(http://image.tianjimedia.com/TLimages2009/yesky/images/index/navonbg.png) repeat-y;z-index:1;top:25px;left:1px;display:inline-block;}.y_headsel dd.show span {position:relative;right:1px;background:#c9e0f2;border:1px solid #7FB5DE;display:block;}.y_headsel dd.show a {display:block;line-height:24px;width:70px;clear:both;word-break:normal;}.y_headsel dt.wtwo, .y_headsel dd.show.wtwo {width:62px;}.y_headsel dd.show.wtwo a {width:60px;}.y_headsel dt.wsix, .y_headsel dd.show.wsix {width:50px;}.y_headsel dd.show.wsix a {width:48px;}.y_headsel dt.wfive, .y_headsel dd.show.wfive {width:74px;}.y_headsel dd.show.wfive a {width:72px;}.y_headsel dt.win, .y_headsel dd.show.win {width:77px;}.y_headsel dd.show.win a {width:75px;}.y_headsel dd.show a:hover {background:#0f4a78;color:#FFF;text-decoration:none;}.y_headsta {color:#6f6e6e;clear:both;overflow:hidden;padding:6px 0 8px 14px;float:left;}.y_headsta span {padding-right:5px;color:#7B9FBA;}.y_headsta a {padding-right:13px;}</style><div class="y_headPos"><div class="y_headtopDiv"><div class="y_headlogo"><a href="http://www.yesky.com/"  target="_self">天极网</a></div><div class="y_headlogin"><script type="text/javascript" src='http://passport.yesky.com/cas/jsclient/outputcookie.js' charset="gbk"></script><script type="text/javascript">if(pinCookie() == null) {document.writeln("<a href=\"http:\/\/passport.yesky.com/\"  target=\"_self\">登录<\/a>|<a href=\"http:\/\/passport.yesky.com\/jsp\/newyesky\/yeskysys_login_i.jsp?auto=1\">注册<\/a>");} else {document.write("<a href=\"http://passport.yesky.com/\">"+getCookie(findNickCookie)+"<\/a>");document.write("|<a href=\"http://q.yesky.com\">群乐<\/a>|<a href=\"http://passport.yesky.com/cas/logout?service="+location.href+"\"  target=\"_self\">退出<\/a>");}</script></div><div class="y_headlinks"><span> <a href="http://www.yesky.com/" class="y_headfrist"  target="_self">天极网首页</a><a href="http://product.yesky.com/" target="_self">产品报价</a><a href="http://product.yesky.com/wenda/"  target="_self">天极问答</a><a href="http://q.yesky.com/"  target="_self">群乐论坛</a><a href="http://buy.yesky.com/"  target="_self">天极商城</a><a href="http://mydown.yesky.com/"  target="_self">软件下载</a><a href="http://auto.yesky.com/"  target="_self">天极汽车</a><a href="http://wap.yesky.com/"  target="_self">手机天极</a></span>
<div class="y_headmore" id="more"><dl><dt>更多</dt><dd><div class="morek"><p><a  target="_self" href="http://news.yesky.com/">新闻</a><a  target="_self" href="http://www.yesky.com/fangtan">访谈</a><a  target="_self" href="http://lab.yesky.com/">评测</a><a  target="_self" href="http://datacenter.yesky.com/">调研</a><a  target="_self" href="http://v.yesky.com/">视频</a><a  target="_self" href="http://buy.yesky.com/">商城</a><a  target="_self" href="http://it365.yesky.com/">商家</a><a  target="_self" href="http://news.yesky.com/newsweek/">新闻周刊</a><a  target="_self" href="http://comic.yesky.com/">动漫</a><a  target="_self" href="http://www.yesky.com/apple/">苹果生活</a></p>
<p class="bdt"><a  target="_self" href="http://notebook.yesky.com/xiaoq/">小Q</a><a  target="_self" href="http://zbj.yesky.com/">知本家</a><a  target="_self" href="http://evildc.yesky.com/">海极社</a><a  target="_self" href="http://qa.dc.yesky.com/">有问必答</a><a  target="_self" href="http://www.yesky.com/sitemap.html">全部>></a></p></div></dd></dl></div></div></div>
<!--nav select div --><div class="y_headsel" id="head_2ndnav"><dl><dt><b><a href="http://mobile.yesky.com/"  target="_self">手机</a></b></dt><dd><span><a href="http://peijian.yesky.com/"  target="_self">配件</a><a href="http://mobile.yesky.com/3g/"  target="_self">3G</a><a href="http://mobilepower.yesky.com/"  target="_self">移动电源</a><a href="http://mobile.yesky.com/windowsphone/"  target="_self">WinPhone</a><a href="http://www.angeeks.com/" target="_self">安极网</a></span></dd></dl><dl> <dt><b><a href="http://notebook.yesky.com/"  target="_self">笔记本</a></b></dt><dd><span><a href="http://pc.yesky.com/"  target="_self">台式机</a><a href="http://aio.yesky.com/"  target="_self">一体电脑</a><a href="http://smb.yesky.com/"  target="_self">商用电脑</a></span></dd></dl><dl><dt class="wfive"><b><a href="http://pad.yesky.com/"  target="_self">平板电脑</a></b></dt> <dd class="wfive"><span><a href="http://ultrabook.yesky.com/"  target="_self">超极本</a></span></dd></dl><dl><dt><b><a href="http://digital.yesky.com/"  target="_self">数码</a></b></dt><dd><span><a href="http://dc.yesky.com/"  target="_self">数码相机</a><a href="http://dc.yesky.com/dslr/"  target="_self">单反相机</a><a href="http://dc.yesky.com/evildc/"  target="_self">单电相机</a><a href="http://dv.yesky.com/"  target="_self">摄像机</a><a href="http://dc.yesky.com/ladydc/"  target="_self">女性相机</a><a href="http://mid.yesky.com/"  target="_self">国产平板</a><a href="http://gps.yesky.com/"  target="_self">GPS</a><a href="http://digital.yesky.com/young/"  target="_self">潮生活</a></span></dd></dl><dl><dt class="wtwo"><b><a href="http://tv.yesky.com"  target="_self">电视机</a></b></dt><dd class="wtwo"><span><a href="http://dh.yesky.com/3d/"  target="_self">3D高清</a><a href="http://www.yesky.com/projector/"  target="_self">投影机</a><a href="http://dh.yesky.com/hdplayer/"  target="_self">播放器</a><a href="http://www.yesky.com/ebook/"  target="_self">电子书</a></span></dd></dl><dl><dt class="wtwo"><b><a href="http://washer.yesky.com/"  target="_self">洗衣机</a></b></dt><dd class="wtwo"><span><a href="http://icebox.yesky.com/"  target="_self">冰箱</a><a href="http://ac.yesky.com/"  target="_self">空调</a><a href="http://dh.yesky.com/life/"  target="_self">小家电</a><a href="http://chuwei.yesky.com/"  target="_self">厨卫</a></span></dd></dl><dl><dt><b><a href="http://lcd.yesky.com/"  target="_self">显示器</a></b></dt><dd><span><a href="http://speaker.yesky.com/"  target="_self">音频</a><a href="http://storage.yesky.com/"  target="_self">内存硬盘</a><a href="http://storage.yesky.com/mst/"  target="_self">移动存储</a></span></dd></dl><dl><dt class="wsix"><b><a href="http://diy.yesky.com/"  target="_self">DIY</a></b></dt><dd class="wsix"><span><a href="http://cpu.yesky.com/"  target="_self">CPU</a><a href="http://input.yesky.com/"  target="_self">键鼠</a><a href="http://zj.yesky.com/"  target="_self">装机</a><a href="http://speaker.yesky.com/"  target="_self">音频</a></span></dd></dl><dl><dt class="wsix"><b><a href="http://mb.yesky.com/"  target="_self">主板</a></b></dt><dd class="wsix"> <span><a href="http://vga.yesky.com/"  target="_self">显卡</a><a href="http://power.yesky.com/"  target="_self">机电</a></span></dd></dl><dl><dt><b><a href="http://server.yesky.com/"  target="_self">服务器</a></b></dt><dd><span><a href="http://net.yesky.com/"  target="_self">网络设备</a><a href="http://news.yesky.com/"  target="_self">IT新闻</a></span></dd></dl><dl><dt><b><a href="http://oa.yesky.com"  target="_self">办公OA</a></b></dt><dd><span><a href="http://bizsoft.yesky.com/"  target="_self">信息化</a><a href="http://server.yesky.com/Solution/"  target="_self">方案库</a><a href="http://oa.yesky.com/hpsmbink/"  target="_self">商用喷墨</a></span></dd></dl><dl><dt><b><a href="http://mydown.yesky.com/"  target="_self">下载</a></b></dt><dd><span><a href="http://dev.yesky.com/"  target="_self">开发</a><a href="http://bizsoft.yesky.com/"  target="_self">信息化</a><a href="http://tools.yesky.com/"  target="_self">工具软件</a><a href="http://soft.yesky.com/mobile/"  target="_self">手机软件</a></span></dd></dl><dl><dt class="wsix"><b><a href="http://game.yesky.com/" target="_self">游戏</a></b></dt><dd class="wsix"><span><a href="http://soft.yesky.com/" target="_self">软件</a><a href="http://auto.yesky.com/"  target="_self">汽车</a><a href="http://pic.yesky.com/" target="_self">图片</a><a href="http://fashion.yesky.com/" target="_self">时尚</a></span></dd></dl><dl><dt class="win"><b><a href="http://win8.yesky.com/" target="_self">Windows</a></b></dt><dd class="win"><span><a href="http://nctech.yesky.com/" target="_self">脑残科技</a><a href="http://www.yesky.com/apple/" target="_self">苹果频道</a></span></dd></dl></div><div class="y_headsta"><span>全国分站：</span><a href="http://bj.yesky.com/">北京</a><a href="http://hd.yesky.com/">上海</a><a href="http://gz.yesky.com/">广州</a><a href="http://szhk.yesky.com/">深港</a><a href="http://nj.yesky.com/">南京</a><a href="http://fj.yesky.com/">福建</a><a href="http://sy.yesky.com/">沈阳</a><a href="http://xa.yesky.com/">西安</a><a href="http://zz.yesky.com/">郑州</a><a href="http://cd.yesky.com/">成都</a><a href="http://cq.yesky.com/">重庆</a><a href="http://jn.yesky.com/">济南</a><a href="http://hz.yesky.com/">杭州</a><a href="http://wh.yesky.com/">武汉</a><a href="http://cs.yesky.com/">长沙</a></div></div><script type="text/javascript">function $a(id,tag){var re=(id&&typeof id!="string")?id:document.getElementById(id);if(!tag){return re;}else{return re.getElementsByTagName(tag);}}function SwitchTagnav(tit,box,s,show,time){var t=tit.split('/'),b=box.split("/"),ts=$a(t[0],t[1]),bs=$a(b[0],b[1]),s=s||"onmouseover",now=show=show||0,c;for(var i=0;i<ts.length;i++){ts[i].old=ts[i].className.replace("show","");bs[i].old=bs[i].className.replace("show","");reg(i);}function init(){for(var i=0;i<ts.length;i++){ts[i].className=ts[i].old;bs[i].className=bs[i].old;};if(now!=-1){ts[now].className+=(t[2]||"")+" show";bs[now].className+=(b[2]||"")+" show";}}function reg(i){ts[i][s]=function(){clearInterval(c);now=i;init();};if(show!=-1&&time){bs[i].onmouseover=function(){clearInterval(c);};bs[i].onmouseout=function(){go();};ts[i].onmouseout=function(){go();}}if(show==-1&&s=="onmouseover"){ts[i].onmouseout=function(){now=-1;init();}}}function go(){c=setInterval(function(){(now<ts.length-1)?now++:now=0;init();},time);}if(show!=-1&&time){go();};init();}SwitchTagnav("head_2ndnav/dl","head_2ndnav/dd","onmouseover",-1); SwitchTagnav("more/dl","more/dd","onmouseover",-1); </script>
<!-- baidu_tc block_end -->
<div class="ad980"></div>
<div id="wrap">
<!-- baidu_tc block_begin: {"action":"SHOW","type":"LOGIN"} -->
<dl class="subnav"><dt><b><a href="http://www.yesky.com/"><img src="http://image.tianjimedia.com/TLimages2009/yesky/images/content/article_logo.gif"/></a></b>您现在的位置： <a href="http://www.yesky.com/" target="_self">天极网</a> > 新闻 > <span></span></dt><dd>
<form name="search" method="get" action="http://search.yesky.com/searchproduct.do"><input class="ssin" id="ss1" onfocus="this.value='';" value="" name="wd"><input class="sssu" id="tbss" type="submit" value=" " name="ssub"></form>
</dd></dl>
<!-- baidu_tc block_end -->
<div class="con_left">
<div class="container">
<div class="ad600 pdt15"></div>
<div class="title blue">
<!-- baidu_tc block_begin: {"action":"SHOW","type":"TITLE"} --><h1>UNIX高级编程指南（十九）之二                                                                        </h1><!-- baidu_tc block_end -->
<div>2000-06-26 00:00　<span>来源：日月光华站</span>　作者：　责任编辑：<em>・</em>yesky　<a href="#pl" target="_self">评论(<span id="commentnumber"></span>)</a></div>
</div>
<div class="ad600"></div>
<div class="article">
<div class="pip_inner"></div>
<!-- baidu_tc block_begin: {"type":"CONTENT","action":"SHOW"} -->
<div class="guanggao"><span id="contentAdv"></span></div>p align="JUSTIFY"><b>19.3 打开伪终端设备</b></p> <p align="JUSTIFY"> 　　在SVR4和4.3+BSD系统中打开伪终端设备的方法有所不同。我们提供两个函数来处理所有细节：ptym_<a href="http://www.yesky.com/key/1853/161853.html" class="bluekey" target="_blank">open</a>用来打开下一个有效的伪终端主设备，ptys_open用来打开相应的从设备。</p> <blockquote>  <blockquote>  <p><a href="http://www.yesky.com/key/3897/133897.html" class="bluekey" target="_blank">#include</a> ourhdr.h<br> <a href="http://www.yesky.com/key/1772/116772.html" class="bluekey" target="_blank">int</a> ptym_open(char *pts_<a href="http://www.yesky.com/key/99/160099.html" class="bluekey" target="_blank">name</a>);</p> </blockquote> </blockquote> <p align="JUSTIFY">　　返回：如果操作成功，返回伪终端主设备文件述符；否则返回-1</p> <blockquote>  <blockquote>  <p>int ptys_open<a href="http://www.yesky.com/key/3891/133891.html" class="bluekey" target="_blank">(int</a> fdm<a href="http://www.yesky.com/key/836/160836.html" class="bluekey" target="_blank">,</a> char *pts_name);</p> </blockquote> </blockquote> <p align="JUSTIFY">　　返回：如果操作成功，返回伪终端从设备文件述符；否则返回-1</p> <p align="JUSTIFY"> 　　通常我们不直接调用这两个函数--函数pty_fork（19.4节）调用它们并fork出一个子进程。ptym_open决定下一个有效的伪终端主设备并打开该设备。这个调用必须分配一个数组来存放主设备或从设备的名称，并且如果调用成功，相应的主设备或从设备的名称会通过pts_name返回。这个名称和ptym_open返回的文件描述符将传给ptys_open，该函数用来打开一个从设备。</p> <p align="JUSTIFY"> 　　在我们讲解pty_fork函数之后，使用两个函数来打开这两个设备的原因将会很明显。通常，一个进程调用ptym_open来打开一个主设备并且得到从设备的名称。该进程然后fork子进程，子进程在调用setid建立新的会话后调用ptys_open来打开从设备。这就是从设备如何成为子进程的控制终端的过程。</p> <p align="JUSTIFY"> <b>19.3.1 系统V的版本4</b></p> <p align="JUSTIFY"> 　　所有在SVR4系统下的伪终端的流实现细节在ATT[1990<a href="http://www.yesky.com/key/4904/159904.html" class="bluekey" target="_blank">d</a>]的第十二章中有所说明。三个函数在下列手册页中描述：grantpt(3)，unlockpt(3)，和ptsname(3)。伪终端主设备是/<a href="http://www.yesky.com/key/3475/123475.html" class="bluekey" target="_blank">dev</a>/ptmx。这是一个流的增殖设备。这意味着当我们打开该增殖设备，其open例程自动决定第一个未被使用的伪终端主设备并打开这个设备。（在下一节我们将看到在Berkeley系统中，我们必须自己找到第一个未被使用的伪终端主设备。）</p> <blockquote>  <blockquote>  <p>________________________________________________________<br> #include <br> #include <br> #include <br> #include <br> #include <br> #include ourhdr.h<br> extern char *ptsname(int); /* prototype not <a href="http://www.yesky.com/key/1568/161568.html" class="bluekey" target="_blank">in</a> any <a href="http://www.yesky.com/key/2113/102113.html" class="bluekey" target="_blank">system</a>  header */<br> int   > ptym_open(char *pts_name)<br> {<br> char *ptr;<br> int fdm;<br> strcpy(pts_name, /dev/ptmx); /* in case open fails */<br> <a href="http://www.yesky.com/key/2095/117095.html" class="bluekey" target="_blank">if</a> ( (fdm = open(pts_name, O_RDWR)) 0)<a href="http://www.yesky.com/key/148/105148.html" class="bluekey" target="_blank">return</a>(-<a href="http://www.yesky.com/key/3696/133696.html" class="bluekey" target="_blank">1)</a>;<br> <a href="http://www.yesky.com/key/2274/147274.html" class="bluekey" target="_blank">if</a> (grantpt(fdm) 0) { /* grant <a href="http://www.yesky.com/key/4675/134675.html" class="bluekey" target="_blank">access</a> to slave */<br> close(fdm);<br> return(-2);<br> }<br> if (unlockpt(fdm) 0) { /* clear slaves lock flag */<br> close(fdm);<br> return(-3);<br> }<br> if ( (ptr = ptsname(fdm)) == <a href="http://www.yesky.com/key/550/110550.html" class="bluekey" target="_blank">NULL</a>) { /* <a href="http://www.yesky.com/key/4000/119000.html" class="bluekey" target="_blank">get</a> slaves name */<br> close(fdm);<br> return(-4);<br> }<br> strcpy(pts_name, ptr); /* return name <a href="http://www.yesky.com/key/1564/161564.html" class="bluekey" target="_blank">of</a> slave */<br> return(fdm); /* return fd of <a href="http://www.yesky.com/key/4957/159957.html" class="bluekey" target="_blank">master</a> */<br> }<br> int<br> ptys_open(int fdm, char *pts_name)<br> {<br> int fds;<br> /* following should <a href="http://www.yesky.com/key/4606/129606.html" class="bluekey" target="_blank">allocate</a> controlling <a href="http://www.yesky.com/key/1731/101731.html" class="bluekey" target="_blank">terminal</a> */<br> if ( (fds = open(pts_name, O_RDWR)) 0) {<br> close(fdm);<br> return(-5);<br> }<br> if (ioctl(fds, <a href="http://www.yesky.com/key/2789/147789.html" class="bluekey" target="_blank">I</a>_PUSH, ptem) 0) {<br> close(fdm);<br> close(fds);<br> return(-6);<br> }<br> if (ioctl(fds, <a href="http://www.yesky.com/key/927/160927.html" class="bluekey" target="_blank">I</a>_PUSH, ldterm) 0) {<br> close(fdm);<br> close(fds);<br> return(-7);<br> }<br> if (ioctl(fds, I_PUSH, ttcompat) 0) {<br> close(fdm);<br> close(fds);<br> return(-<a href="http://www.yesky.com/key/4686/159686.html" class="bluekey" target="_blank">8</a>);<br> }<br> return(fds);<br> }<br> _______________________________________________________________<br> 程序19.1 SVR4的伪终端打开函数</p> </blockquote> </blockquote> <p align="JUSTIFY"> 　　我们首先打开设备/dev/ptmx并得到伪终端主设备的文件描述符。打开这个主设备自动锁定了对应的从设备。</p> <p align="JUSTIFY"> 　　我们然后调用grantpt来改变从设备的<a href="http://www.yesky.com/key/4393/139393.html" class="bluekey" target="_blank">权限</a>。执行如下操作：（a）将从设备的所有权改为有效用户<a href="http://www.yesky.com/key/2456/107456.html" class="bluekey" target="_blank">ID</a>；（b）将组所有权改为组tty；（c）将权限改为只允许<a href="http://www.yesky.com/key/446/100446.html" class="bluekey" target="_blank">user</a>-<a href="http://www.yesky.com/key/472/105472.html" class="bluekey" target="_blank">read</a>，user-write和<a href="http://www.yesky.com/key/1597/161597.html" class="bluekey" target="_blank">group</a>-write。将组所有权设置为tty并允许group-write权限是因为程序wall(1)和write(1)的组标识符被设置为组tty。调用函数grantpt执行/user/lib/pt_chmod。该程序的用户被设置为<a href="http://www.yesky.com/key/2045/162045.html" class="bluekey" target="_blank">root</a>因此它能够修改从设备的所有者和权限。</p> <p align="JUSTIFY"> 　　函数unlockpt用来清除从设备的<a href="http://www.yesky.com/key/266/155266.html" class="bluekey" target="_blank">内部</a>锁。在打开从设备前我们必须做这件事情。并且我们必须调用ptsname来得到从设备的名称。这个名称的格式是/dev/pts/NNN。文件中接下来的函数是ptys_open，该函数真正被用来打开一个从设备。在SVR4系统中，如果调用者是一个还没有控制终端的会话，open就会分配一个从设备作为控制终端。如果我们不希望函数自动做这件事，可以在调用时指明O_NOCTTY标志。</p> <p align="JUSTIFY"> 　　在打开从设备后，我们将三个流模块放在从设备的流上。Ptem是伪终端虚拟模块，ldterm是终端行规程模块。这两个模块合在一起象一个真正的终端模块一样工作。ttcompat提供了向老系统如V7、4BSD和Xenix的ioctl调用的<a href="http://www.yesky.com/key/1207/161207.html" class="bluekey" target="_blank">兼容</a>性。这是一个可选的模块，但是因为它自动尝试控制台登录和网络登录（见程序12.10的输出），我们将其加到从设备的流中。</p> <p align="JUSTIFY"> 　　调用这两个函数的结果是得到：伪终端主设备的文件描述符和从设备的文件描述符。19.3.2  4.3+BSD在4.3+BSD系统中我们必须自己来确定第一个可用的伪终端主设备。为达到这个目的，我们从/dev/ptyp0开始并不断尝试直到成功打开一个可用的伪终端主设备或试完所有设备。在打开设备的时候，我们会看到两种可能的错误：EIO指设备已经被使用；ENOENT表示设备不存在。在后一种情况，我们可以停止搜索，因为所有的伪终端设备都在被使用中。一旦我们成功打开一个例如名为/dev/ptyMN的伪终端主设备，那么对应的从设备的名称为/dev/ttyMN。</p> <p align="JUSTIFY"> 　　程序19.2中的函数ptys_open打开该从设备。我们在该函数中调用<a href="http://www.yesky.com/key/857/125857.html" class="bluekey" target="_blank">chown</a>和chmod，必须意识到调用这两个函数的进程必须有<a href="http://www.yesky.com/key/462/90462.html" class="bluekey" target="_blank">超级用户</a>的权限。如果必须改变权限标志，那么这两个函数必须放在一个<a href="http://www.yesky.com/key/1603/161603.html" class="bluekey" target="_blank">set</a>_user_ID的root用户的可执行程序中，这类似于4.3+BSD系统下的grantpt函数。</p> <p align="JUSTIFY"> 　　在4.3+BSD系统之下打开pty从设备不具有象分配作为控制终端的设备那样的<a href="http://www.yesky.com/key/4282/84282.html" class="bluekey" target="_blank">副作用</a>。我们将在下一节<a href="http://www.yesky.com/key/3750/148750.html" class="bluekey" target="_blank">探讨</a>如何在4.3+BSD系统下分配控制终端。这个函数尝试<a href="http://www.yesky.com/key/3444/133444.html" class="bluekey" target="_blank">16</a>个不同的伪终端主设备：从/dev/ptyp0到/dev/ptyTf。具体有效的pty设备号取决于两个因素：（a）在内核中配置的号码；（b）在/dev目录下的特殊文件号。对于任何程序来说，有效的号码是（a）和（b）中较小的一个。并且，即使（a）和（b）中小的值大于<a href="http://www.yesky.com/key/3248/98248.html" class="bluekey" target="_blank">64</a>，许多现有的BSD应用（telnetd，rlogind，等等）会搜索程序19.2中第一个for循环中的pqrs。</p> <blockquote>  <blockquote>  <p>______________________________________________________<br> #include <br> #include <br> #include <br> #include <br> #include <br> #include ourhdr.h</p> </blockquote> </blockquote> <p align="JUSTIFY">　　使用ENOENT表示设备不存在。在后一种情况，我们可以停止搜索，因为所有的伪终端设备都在被使用中。一旦我们成功打开一个例如名为/dev/ptyMN的伪终端主设备，那么对应的从设备的名称为/dev/ttyMN。</p> <p align="JUSTIFY"> 　　程序19.2中的函数ptys_open打开该从设备。我们在该函数中调<a href="http://www.yesky.com/key/3310/138310.html" class="bluekey" target="_blank">用c</a>hown和chmod，必须意识到调用这两个函数的进程必须有<a href="http://www.yesky.com/key/623/90623.html" class="bluekey" target="_blank">超级</a>用户的权限。如果必须改变权限标志，那么这两个函数必须放在一个set_user_ID的root用户的可执行程序中，这类似于4.3+BSD系统下的grantpt函数。</p> <p align="JUSTIFY"> 　　在4.3+BSD系统之下打开pty从设备不具有象分配作为控制终端的设备那样的副作用。我们将在下一节探讨如何在4.3+BSD系统下分配控制终端。</p> <p align="JUSTIFY"> 　　这个函数尝试16个不同的伪终端主设备：从/dev/ptyp0到/dev/ptyTf。具体有效的pty设备号取决于两个因素：（a）在内核中配置的号码；（b）在/dev目录下的特殊文件号。对于任何程序来说，有效的号码是（a）和（b）中较小的一个。并且，即使（a）和（b）中小的值大于64，许多现有的BSD应用（telnetd，rlogind，等等）会搜索程序19.2中第一个for循环中的pqrs。</p> <blockquote>  <blockquote>  <p>_________________________________________________________<br> #include <br> #include <br> #include <br> #include <br> #include <br> #include ourhdr.h<br> int<br> ptym_open(char *pts_name)<br> {<br> int fdm;<br> char *ptr1, *ptr2;<br> strcpy(pts_name, /dev/ptyXY);<br> /* <a href="http://www.yesky.com/key/4122/129122.html" class="bluekey" target="_blank">array</a> <a href="http://www.yesky.com/key/3995/133995.html" class="bluekey" target="_blank">index</a>: 0123456789 (for references in following <a href="http://www.yesky.com/key/2884/137884.html" class="bluekey" target="_blank">code</a>)  */<br> for (ptr1 = pqrstuvwxyzPQRST; *ptr1 != 0; ptr1++) {<br> pts_name[8] = *ptr1;<br> for (ptr2 = 0123456789abcdef; *ptr2 != 0; ptr2++) {<br> pts_name[9] = *ptr2;<br> /* try to open master */<br> if ( (fdm = open(pts_name, O_RDWR)) 0) {<br> if (errno == ENOENT) /* different from EIO */<br> return(-1); /* out opty devices */<br> else<br> continue; /* try nxt pty device */<br> }pts_name[5] = <a href="http://www.yesky.com/key/786/160786.html" class="bluekey" target="_blank">t</a>;<br> /* change pty to tty */return(fdm); <br> /* got <a href="http://www.yesky.com/key/1119/136119.html" class="bluekey" target="_blank">it</a>, return fd of master */<br> }<br> }<br> return(-1); /* out of pty devices */<br> }<br> int<br> ptys_open(int fdm, char *pts_name)<br> {<br> <a href="http://www.yesky.com/key/2457/102457.html" class="bluekey" target="_blank">struct</a> group *grptr;<br> int gid, fds;<br> if ( (grptr = getgrnam(tty)) != NULL)gid = grptr-<a href="http://www.yesky.com/key/3570/118570.html" class="bluekey" target="_blank">gr</a>_gid;<br> else<br> gid = -1; /* group tty <a href="http://www.yesky.com/key/2516/152516.html" class="bluekey" target="_blank">is</a> not in the group <a href="http://www.yesky.com/key/617/120617.html" class="bluekey" target="_blank">file</a> */<br> /* following two functions dont work unless were root/<br> chown(pts_name, getuid(), gid);<br> chmod(pts_name, S_IRUSR | S_IWUSR | S_IWGRP);<br> if ( (fds = open(pts_name, O_RDWR)) 0) {<br> close(fdm);<br> return(-1);<br> }<br> return(fds);<br> }<br> _______________________________________________________<br> 程序19.2 4.3+BSD系统下的伪终端open函数</p> </blockquote> </blockquote> 
<!-- baidu_tc block_end -->
</div>


<!-- baidu_tc block_begin: {"action":"SHOW", "type":"PAGE_TURNING"} -->
<div id="numpage"></div>
<!-- baidu_tc block_end -->
<div class="clear"></div>
<div class="box3 blue">
<style>
.qqhy{width:24px;height:24px;float:left;overflow:hidden;_margin-top:6px}
.qhy{float:left;width:52px;height:24px;text-align:center;color:#0082cb;cursor:pointer;line-height:24px;_margin-top:6px}
</style>
<strong>分享到：</strong>
<div class="shareIcon">
<div class="qqhy"><script type="text/javascript">
            (function() {
                var p = {
                    url: location.href,/*获取URL，可加上来自分享到QQ标识，方便统计*/
                    desc: '看看这个吧', /*默认分享理由(推荐填写，风格应模拟用户对话)*/
                    site: 'QQ分享',/*分享来源 (可选) ，如：QQ分享*/ 
                    style: '202',
                    width: 39,
                    height: 39
                };
                var s = [];
                for (var i in p) {
                    s.push(i + '=' + encodeURIComponent(p[i] || ''));
                }
                document.write(['<a version="1.0" class="qcShareQQDiv" href="http://connect.qq.com/widget/shareqq/index.html?', s.join('&'), '" target="_blank">分享到QQ</a>'].join(''));
            })();
</script> 
<script src="http://connect.qq.com/widget/loader/loader.js" widget="shareqq" charset="utf-8"></script></div><span class="qhy">QQ好友</span>
<a href="javascript:void(0)" onclick="pShare(oH.qzone);return false;" title="分享到QQ空间" class="qk">QQ空间</a>
<a href="javascript:void(0)" onclick="yeskyweibo();return false;" title="新浪微博分享" class="xl">新浪微博</a>
<a href="javascript:void(0)" onclick="pShare(oH.vtQQ,'width=700, height=680');return false;" title="转播到腾讯微博" class="qq">腾讯微博</a>
<a href="javascript:void(0)" onclick="pShare(oH.ren);return false;" title="转帖到人人网" class="rr">人人网</a>
<a href="javascript:void(0)" onclick="pShare(oH.feixin);return false;" title="飞信" class="fx"></a>
<a title="其他分享"  href="javascript:void(0)" id="shareOther" class="more" target="_self"></a>
<script src="http://js.tianjimedia.com/TLimages2009/yesky/js/shareWB.js" type="text/javascript"></script>
</div>
</div>
<script type="text/javascript">
function yeskyweibo(){
   var url='http://comment.yesky.com/weibo/redirect.jsp?title='+encodeURI(articletitle)+'&articleId='
            +referId+'&articleUrl='+location.href+'&channelId='+channelId+'&timestamp='+new Date().getTime(); 
   window.open(url);
}
</script>
<div class="clear"></div>
</div>
<div class="xgcpbox bd1 mgt8">
 

<a id="pl"></a>
</div>

<div class="ad670 mgt8"></div>
<script language="JavaScript">
<!--
var site = 'yesky';//站点名称
var type = 'article';//评论类型
var articletitle = 'UNIX高级编程指南（十九）之二                                                                        ';
var referId = 85975;
var channelId = 22;
var articleurl= 'http://www.yesky.com/475/85975.shtml';
var artckey = '';
if (channelId==0) channelId=22;
//-->
</script>
<span id="contentpl"></span>
</div>
<div class="con_right">

<div class="ad300"></div>
<div class="ad300"></div>

<div class="box298 bd1 mgb8">
<div class="artitle gray"><h3>精彩推荐</h3></div>
<div class="jctj">
<h3><a href="http://wh.yesky.com/21/34835521.shtml">双模双待智能机推荐</a></h3>
<a href="http://wh.yesky.com/21/34835521.shtml"><img src="http://image.tianjimedia.com//uploadImages/2013/142/4H55T534H407_2_1.jpg" alt="双模双待智能机推荐"/></a>
<span>相比双卡双待，双模双待的手机因为它可以支持更多运营商的网络服务而更加受到商务人士的欢迎，双模双待是指在同一部手机内可使用… <a href="http://wh.yesky.com/21/34835521.shtml" class="blue">[详情]</a> </span>
</div>
</div>
 
<div class="ad300 pdb8" id="right_baidu_adbox"></div>

<div class="box298 bd1 mgb8">
<div class="artitle gray"><h3>月度文章排行榜</h3></div>
<div class="wzph">
<dl><dt><a href="http://dh.yesky.com/hdplayer/357/34630857.shtml">小长假预热 高清播放机无限播放电影</a></dt></dl>
<dl><dt><a href="http://pad.yesky.com/109/34630609.shtml">PC平板2-in-1 惠普ENVY x2视频解析</a></dt></dl>
<dl><dt><a href="http://pad.yesky.com/359/34629859.shtml">闪开,惠普ENVY x2是我的！</a></dt></dl>
<dl><dt><a href="http://pad.yesky.com/327/34579327.shtml">性价比王者 3G版MediaPad10 Link评测</a></dt></dl>
<dl><dt><a href="http://notebook.yesky.com/392/34602892.shtml">六款热门移动设备键盘横评</a></dt></dl>
<dl><dt><a href="http://input.yesky.com/427/34603927.shtml">艾迪索NuScan3200u扫描仪评测</a></dt></dl>
<dl><dt><a href="http://mobile.yesky.com/376/34638876.shtml">华硕Padfone Infinity万字跨界评测</a></dt></dl>
<dl><dt><a href="http://dh.yesky.com/hdplayer/84/34639084.shtml">高清双核时代 杰科R1智能电视盒评测</a></dt></dl>
<dl><dt><a href="http://input.yesky.com/194/34630694.shtml">助力LOL 4款87键位机械键盘推荐</a></dt></dl>
<dl><dt><a href="http://mobile.yesky.com/381/34630881.shtml">F1.9大光圈 诺基亚Lumia 720首发评测</a></dt></dl>
</div>
</div>


<span id="jxslist"></span>
<div class="box298 bd1 mgb8">
<div class="artitle gray bg0"><h3>品牌</h3></div>
<div class="prpp"><a href="http://product.yesky.com/notebookpc/hp/">HP</a><a href="http://product.yesky.com/notebookpc/thinkpad/">ThinkPad</a><a href="http://product.yesky.com/notebookpc/dell/">戴尔</a><a href="http://product.yesky.com/notebookpc/sony/">索尼</a><a href="http://product.yesky.com/notebookpc/lenovo/">联想</a><a href="http://product.yesky.com/notebookpc/asus/">华硕</a><a href="http://product.yesky.com/notebookpc/samsung/">三星</a><a href="http://product.yesky.com/notebookpc/hasee/">神舟</a><a href="http://product.yesky.com/notebookpc/acer/">宏</a><a href="http://product.yesky.com/notebookpc/toshiba/">东芝</a><a href="http://product.yesky.com/notebookpc/fujitsu/">富士通</a><a href="http://product.yesky.com/notebookpc/haier/">海尔</a><a href="http://product.yesky.com/notebookpc/tongfang/">同方</a><a href="http://product.yesky.com/notebookpc/founder/">方正</a><a href="http://product.yesky.com/notebookpc/greatwall/">长城</a></div>
</div>
<div class="box298 bd1">
<div class="artitle gray bg0"><h3>焦点</h3></div>
<div class="jdss"><a href="http://ultrabook.yesky.com/">Ultrabook</a><a href="http://product.yesky.com/product/685/685437/">ipad2</a><a href="http://product.yesky.com/product/712/712092/" class="zt18">小米M1</a><a href="http://product.yesky.com/switchboard/cisco/">思科交换机</a><a href="http://product.yesky.com/router/cisco/">思科路由器</a><a href="http://product.yesky.com/product/607/607001/" class="zt24">诺基亚N8</a><a href="http://product.yesky.com/hardwarefirewall/cisco/">思科防火墙</a><a href="http://product.yesky.com/mp4_mp5/">MP5</a><a href="http://product.yesky.com/refrigerator/midea/" class="zt20">美的冰箱</a><a href="http://product.yesky.com/product/635/635993/">诺基亚N9</a><a href="http://ultrabook.yesky.com/" class="zt30">超极本</a><a href="http://product.yesky.com/mobilephone/nokia/">诺基亚手机</a><a href="http://product.yesky.com/product/665/665004/">中兴V880</a><a href="http://product.yesky.com/product/542/542009/">诺基亚5230</a><a href="http://product.yesky.com/product/705/705768/">iphone 4s</a></div>
</div>

<div class="clear"></div>

<div class="ad300 pdt8" id="right_taobao_adbox"></div>
</div>
</div>

<!--评论s-->

<div class="none">
<span id="span_contentpl"> 
<script language="javascript">
<!--
 if(typeof(referId) != "undefined") { 
document.write("<script language=\"JavaScript\" charset=\"gb2312\"  src=\"http://comment.yesky.com/commentjs/"+site+"/"+type+"/"+(referId%5000)+"/"+referId+".js\"><\/script>");                          }
//-->
</script>	  
<div id="__pl">
<script language="JavaScript" src="/TLimages2009/yesky/js/y_article_comment.js"></script>
</div>
</span>
</div>
<script language="JavaScript">
document.getElementById("contentpl").innerHTML=document.getElementById("span_contentpl").innerHTML;document.getElementById("span_contentpl").innerHTML="";
</script>
<!--评论e-->

<!--* 去哪买 & 经销商推荐*-->
<span id="span_jxslist"> 
<script type="text/javascript">
if(v_productid>0){
document.write("<script src=\"http://interface.product.yesky.com/partner/product/propricewithregion.do?productid="+v_productid+"&rtype=js\"><\/script>");
document.write("<script type=\"text/javascript\" src=\"http://js.tianjimedia.com/TLimages2009/yesky/js/Yesky_Article_jxslist_new.js\"><\/script>");
}
</script>
</span>
<script type="text/javascript">
document.getElementById("jxslist").innerHTML=document.getElementById("span_jxslist").innerHTML;document.getElementById("span_jxslist").innerHTML="";
</script>

<!--baidu taobao-->
<span id="span_right_baidu_adbox"><script type="text/javascript">/*文章页广告位*/ var cpro_id = 'u702233';</script><script src="http://cpro.baidu.com/cpro/ui/c.js" type="text/javascript"></script></span> 
<span id="span_right_taobao_adbox"> 

</span> 
<script type="text/javascript">
document.getElementById("right_baidu_adbox").innerHTML=document.getElementById("span_right_baidu_adbox").innerHTML;
document.getElementById("span_right_baidu_adbox").innerHTML="";

document.getElementById("right_taobao_adbox").innerHTML=document.getElementById("span_right_taobao_adbox").innerHTML;
document.getElementById("span_right_taobao_adbox").innerHTML="";
</script>

<div id="foot">
<div class="clear"></div>
<style type="text/css">
.channel_content{width:950px;color:#595959;margin:0 auto;text-align:center;padding:0;font-size:12px;font-family:"Arial";line-height:22px;margin-top:17px; margin-bottom:15px!important;_float:none;}
.channel_content a {margin:0 5px 0 11px;}
.channel_content a:link,.channel_content a:visited {text-decoration:none;color:#595959;}
.channel_content a:hover,.channel_content a:active {text-decoration:underline;color:#595959;}
</style>
<div class="channel_content">
<a href="http://www.tianjimedia.com/372/11453872.shtml" rel="nofollow">关于我们</a>|<a href="http://www.tianjimedia.com/english/" rel="nofollow">About us</a>|<a href="http://www.tianjimedia.com/382/11453882.shtml" rel="nofollow">天极服务</a>|<a href="http://www.yesky.com/focus/" rel="nofollow">天极大视野</a>|<a href="http://www.tianjimedia.com/more/32560_22516_tjdt_1.shtml" rel="nofollow">天极动态</a>|<a href="http://www.tianjimedia.com/412/11453912.shtml" rel="nofollow">加入我们</a>|<a href="http://www.yesky.com/sitemap.html">网站地图</a>|<a href="http://www.tianjimedia.com/408/11453908_4.shtml" rel="nofollow">网站律师</a>|<a href="http://link.yesky.com/">友情合作</a>|<a href="http://rss.yesky.com/" rel="nofollow">RSS订阅</a>|<a href="http://opinion.yesky.com/reader/reader.jhtml?sitemapId=22&url=http://www.yesky.com" rel="nofollow">意见反馈</a><br />Copyright (C) 1999-2013 Yesky.com, All Rights Reserved 版权所有 天极网络 
</div>
<!--intel-->
<script type="text/javascript">
    var channelIds = {/*笔记本*/"323": true, /*超极本*/"503924": true,  /*主板*/"3772": true,  /*CPU*/"3777": true, /*手机*/ "327": true,  /*数码相机*/"511": true,  /*数码摄像机*/"1152": true,  /*平板电脑*/"117468": true, /*网络游戏*/ "445": true,  /*PC*/"3105": true,  /*新闻*/"36220": true,  /*一体电脑*/"69442": true};
    if (typeof(referId) != "undefined" && typeof(channelId) != "undefined" && channelIds["" + channelId]) {
         document.write('<script src="http://intel-sa-ad.yesky.com/js/common/jquery.js" type="text/javascript" charset="utf-8"><' + '/script><script id="zever_assist" type="text/javascript" src="http://intel-sa-ad.yesky.com/js/zever_assist_script.js?platform=yesky&articleID='+channelId+'&width=980" charset="utf-8"><' + '/script>');
    }
</script>	 
</div>

<!--baidu-->
<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?1ea718e91cc76f83c934bb63de2d7290";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script src="http://www.yesky.com/monitorjs/imp-zz.js"></script>








<!-- baidu-tc footer{"type":"CLEAN","return_text":"天极WAP站","return_href":"http://wap.yesky.com/","channel_text_1":"返回天极网首页","channel_href_1":"http://www.yesky.com/"}-->
</body></html>                                                                                                             